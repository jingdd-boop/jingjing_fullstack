# TCP
TCP协议的定义和丢包时的重传机制
TCP的流迭 拥塞处理

## TCP头格式
1、tcp的包时没有ip地址 有源端口和目的端口
2、有四个很重要的东西
- Sequence Number 是包的序号 用来解决网络包的乱序问题
- Acknowledgement Number 就是ACK 用于确认收到 用来解决不丢包的问题
- Window又叫Advertised-Window 也就是著名的滑动窗口 用于解决流控
- TCP Flag 包类型 主要用于操控TCP的状态机

## TCP的状态机
1、网络上的传输是没有连接的，包括TCP也是一样的，而TCP所谓的连接，其实只不过是在通讯双方维护的一个连接状态，让它看上去好像有连接一样
2、TCP的三次握手
- 服务器端先变成listen()状态
- 客户端主动发出请求SYN,同时客户端变成SYN_SENT状态
- 服务器端接收到客户端发过来的SYN，于是自己的状态变成SYN_RCVD,然后返回ACK确定收到 
- 客户端接收到有服务器发过来的ACK然后，变成 ESTABLISHED
- 客户端再发送ACK给服务器端 此时服务器端也变成 ESTABLISHED

3、开始传输数据
 
4、TCP四次挥手
- 客户端先变成FIN_WAIT_1 发送FIN给服务器 ，服务器变成 CLOSE_WAIT
- 服务器发送ACK给客户端 客户端变成FIN_WAIT_2
- 服务器端变成 LAST_ACK，并发送FIN给客户端 
- 客户端变成 TIME_WAIT 再发送ACK给服务器端
- 之后服务器等待 2个报文传输事件

## 为什么要三次握手
- 主要是初始化 Sequence Number 是包的序号 的初始值。通信双方要互相通知对方自己的初始化Sequence Number 是包的序号SYN 

这个号要作为以后的数据通信的序号，以保证应用层接收到的数据不会因为网络上的传输的问题而乱序（TCP会用这个序号来拼接数据）

## 为什么要4次挥手
其实是2次，因为TCP是全双工的，所以，发送方和接收方都需要Fin和Ack

只不过，有一方是被动的，所以看上去就成了所谓的4次挥手。

如果两边同时断连接，那就会就进入到CLOSING状态，然后到达TIME_WAIT状态。

## TCP重传机制
保证所有的数据包都可以到达，所有必须有重传机制

接收端给发送端的ACK确认只会确定最后一个连续的包，
比如，发送端发了1,2,3,4,5一共五份数据

接收端收到了1、2，于是回ack 3，然后收到了4(此时3没有收到)

SeqNum和Ack是以字节数为单位，所以ack的时候，不能跳着确认，只能确认最大的连续收到的包，不然，发送端就以为之前的都收到了。